package {{package}}.mcp.resources;

import io.modelcontextprotocol.spec.McpSchema.ReadResourceResult;
import io.modelcontextprotocol.spec.McpSchema.ResourceContents;
import io.modelcontextprotocol.spec.McpSchema.TextResourceContents;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;
import tools.jackson.databind.JsonNode;
import tools.jackson.databind.ObjectMapper;

/**
 * Unit tests for UserInfoResource.
 */
class UserInfoResourceTest {

  private UserInfoResource userInfoResource;
  private final ObjectMapper mapper = new ObjectMapper();

  @BeforeEach
  void setUp() {
    userInfoResource = new UserInfoResource(mapper);
  }

  @Test
  @DisplayName("Should return user info in JSON using ReadResourceResult")
  void shouldReturnUserInfoSuccessfully() {
    // Given
    String userId = "123";

    // When
    Mono<ReadResourceResult> resultMono = userInfoResource.getUserInfo(userId);

    // Then
    StepVerifier.create(resultMono)
        .assertNext(result -> {
          List<ResourceContents> contents = result.contents();
          assert contents.size() == 1;

          ResourceContents content = contents.get(0);
          assert content instanceof TextResourceContents;

          TextResourceContents text = (TextResourceContents) content;

          assert text.uri().equals("resource://users/" + userId);
          assert text.mimeType().equals("application/json");

          // Validate valid JSON
          JsonNode jsonNode;
          jsonNode = mapper.readTree(text.text());

          // Validate UserInfo model fields
          assert jsonNode.get("userId").asInt() == Integer.parseInt(userId);
          assert jsonNode.has("name");
          assert jsonNode.has("email");
          assert jsonNode.has("status");
        })
        .verifyComplete();
  }

  @Test
  @DisplayName("Should return error when ID is invalid")
  void shouldReturnErrorForInvalidUserId() {
    // Given
    String invalidUserId = "abc";

    // When
    Mono<ReadResourceResult> resultMono = userInfoResource.getUserInfo(invalidUserId);

    // Then
    StepVerifier.create(resultMono)
        .assertNext(result -> {
          ResourceContents content = result.contents().get(0);
          assert content instanceof TextResourceContents;

          TextResourceContents text = (TextResourceContents) content;

          assert text.uri().equals("resource://users/" + invalidUserId);
          assert text.mimeType().equals("application/json");

          String json = text.text();
          assert json.contains("error");
          assert json.contains("userId");
          assert json.contains("IllegalArgumentException");
        })
        .verifyComplete();
  }

  @Test
  @DisplayName("Should return error when ID is negative")
  void shouldReturnErrorForNegativeUserId() {
    // Given
    String negativeUserId = "-1";

    // When
    Mono<ReadResourceResult> resultMono = userInfoResource.getUserInfo(negativeUserId);

    // Then
    StepVerifier.create(resultMono)
        .assertNext(result -> {
          ResourceContents content = result.contents().get(0);
          assert content instanceof TextResourceContents;

          TextResourceContents text = (TextResourceContents) content;

          String json = text.text();
          assert json.contains("error");
          assert json.contains("positive");
        })
        .verifyComplete();
  }
}
