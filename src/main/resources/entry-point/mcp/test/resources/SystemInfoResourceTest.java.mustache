package {{package}}.mcp.resources;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.modelcontextprotocol.spec.McpSchema.ReadResourceResult;
import io.modelcontextprotocol.spec.McpSchema.ResourceContents;
import io.modelcontextprotocol.spec.McpSchema.TextResourceContents;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

/**
 * Unit tests for SystemInfoResource.
 */
class SystemInfoResourceTest {

  private SystemInfoResource systemInfoResource;
  private final ObjectMapper mapper = new ObjectMapper();

  @BeforeEach
  void setUp() {
    systemInfoResource = new SystemInfoResource(mapper);
  }

  @Test
  @DisplayName("Should return system info in JSON")
  void shouldReturnSystemInfoSuccessfully() {
    // When
    Mono<ReadResourceResult> resultMono = systemInfoResource.getSystemInfo();

    // Then
    StepVerifier.create(resultMono)
        .assertNext(result -> {
          ResourceContents content = result.contents().get(0);
          assert content instanceof TextResourceContents;

          TextResourceContents text = (TextResourceContents) content;

          assert text.uri().equals("resource://system/info");
          assert text.mimeType().equals("application/json");

          // Validate valid JSON
          JsonNode jsonNode;
          try {
            jsonNode = mapper.readTree(text.text());
          } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
          }

          // Validate expected fields
          assert jsonNode.has("service");
          assert jsonNode.has("version");
          assert jsonNode.has("status");
          assert jsonNode.get("status").asText().equals("UP");
          assert jsonNode.has("reactive");
          assert jsonNode.get("reactive").asBoolean();
        })
        .verifyComplete();
  }

  @Test
  @DisplayName("Should contain Java and OS info")
  void shouldContainJavaAndOSInfo() {
    // When
    Mono<ReadResourceResult> resultMono = systemInfoResource.getSystemInfo();

    // Then
    StepVerifier.create(resultMono)
        .assertNext(result -> {
          TextResourceContents text = (TextResourceContents) result.contents().get(0);
          String json = text.text();

          assert json.contains("javaVersion");
          assert json.contains("os");
        })
        .verifyComplete();
  }
}
